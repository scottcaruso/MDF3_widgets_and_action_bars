package com.scottcaruso.news_feed_widget;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.scottcaruso.geolocationfunctions.DataRetrievalService;
import com.scottcaruso.hereiam.MainActivity;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.os.Messenger;
import android.util.Log;
import android.widget.Toast;

public class GetHeadlines extends Activity {
	
	public static String response;
	
	protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        
        
        
	}
	
    public void getHeadlnes()
    {
     	Handler retrievalHandler = new Handler()
		{
			@Override
			public void handleMessage(Message msg) 
			{
				if (msg.arg1 == RESULT_OK)
				{
					try {
						response = (String) msg.obj;
					} catch (Exception e) {
						Log.e("Error","There was a problem retrieving the json Response.");
					}
					String nullResponse = "{\"results\":[],\"count\":0}";
					if (response.equals(nullResponse))
					{
						Toast toast = Toast.makeText(GetHeadlines.this, "There was a problem retrieving Geo data. Please try again later.", Toast.LENGTH_SHORT);
						toast.show();
					} else
					{
						//When we get a response...
						try {
							//Try to parse it into a valid location plus state
							JSONObject result = new JSONObject(response);
							JSONArray resultArray = result.getJSONArray("geonames");
							JSONObject thisLocation = resultArray.getJSONObject(0);
							String nearestPlace = thisLocation.getString("toponymName");
							String state = thisLocation.getString("adminCode1");
							location = nearestPlace+", "+state;
							Log.i("Location",location);
						} catch (JSONException e) {
							Log.e("Error","Problem parsing JSON data!");
							e.printStackTrace();
						}
						
					}
				}
			}
		};
		Messenger apiMessenger = new Messenger(retrievalHandler);
		
		Intent startDataService = new Intent(this, DataRetrievalService.class);
		startDataService.putExtra(DataRetrievalService.MESSENGER_KEY, apiMessenger);
		startDataService.putExtra(DataRetrievalService.LON_KEY,lon);
		startDataService.putExtra(DataRetrievalService.LAT_KEY,lat);
		this.startService(startDataService);
     }
	}

}
