package com.scottcaruso.news_feed_widget;

import java.util.ArrayList;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.scottcaruso.headlineretrieval.DataRetrievalService;
import com.scottcaruso.news_feed_widget.R;

import android.app.Activity;
import android.app.PendingIntent;
import android.app.PendingIntent.CanceledException;
import android.appwidget.AppWidgetManager;
import android.appwidget.AppWidgetProvider;
import android.content.Context;
import android.content.Intent;
import android.os.Handler;
import android.os.Message;
import android.os.Messenger;
import android.util.Log;
import android.widget.ArrayAdapter;
import android.widget.RemoteViews;

public class NewsWidgetProvider extends AppWidgetProvider {
	
	public static String response;

	public void onUpdate(Context context, AppWidgetManager appWidgetManager, int[] appWidgetIds)
	{
		final int ids = appWidgetIds.length;
		
		for (int i=0; i<ids; i++)
		{
			int appWidgetId = appWidgetIds[i];
			
			//Intent getHeadlines = new Intent(context, GetHeadlines.class);
			Intent getService = new Intent(context, DataRetrievalService.class);
			
			final RemoteViews views = new RemoteViews(context.getPackageName(), R.layout.widget_layout);
			//views.setOnClickPendingIntent(R.id.widget, pi);
			
			Handler retrievalHandler = new Handler()
			{
				@Override
				public void handleMessage(Message msg) 
				{
					if (msg.arg1 == Activity.RESULT_OK)
					{
						try {
							response = (String) msg.obj;
						} catch (Exception e) {
							Log.e("Error","There was a problem retrieving the json Response.");
						}
						String nullResponse = "{\"results\":[],\"count\":0}";
						if (response.equals(nullResponse))
						{
							Log.i("Info","We got back a null response. Uh oh!");
						} else
						{
							
							views.setString(R.id.link1, "setText", headlines.get(0));
							views.setString(R.id.link2, "setText", headlines.get(1));
							views.setString(R.id.link3, "setText", headlines.get(2));
							views.setString(R.id.link4, "setText", headlines.get(3));
							views.setString(R.id.link5, "setText", headlines.get(4));
							views.setString(R.id.link6, "setText", headlines.get(5));
							
						}
					}
				}
			};
			Messenger apiMessenger = new Messenger(retrievalHandler);
			
			getService.putExtra(com.scottcaruso.headlineretrieval.DataRetrievalService.MESSENGER_KEY, apiMessenger);
			PendingIntent ps = PendingIntent.getService(context, 0, getService, 0);
			
			try {
				ps.send();
			} catch (CanceledException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			appWidgetManager.updateAppWidget(appWidgetId, views);
		}
		
	}
	
	public void onDeleted(Context context, int[] appWidgetIds)
	{
		//doNothing
	}
	
	public void getHeadlines()
    {
		
    }
}
