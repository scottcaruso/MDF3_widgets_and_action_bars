package com.scottcaruso.news_feed_widget;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.scottcaruso.headlineretrieval.DataRetrievalService;
import com.scottcaruso.news_feed_widget.R;

import android.app.Activity;
import android.app.PendingIntent;
import android.app.PendingIntent.CanceledException;
import android.appwidget.AppWidgetManager;
import android.appwidget.AppWidgetProvider;
import android.content.Context;
import android.content.Intent;
import android.os.Handler;
import android.os.Message;
import android.os.Messenger;
import android.util.Log;
import android.widget.ArrayAdapter;
import android.widget.RemoteViews;

public class NewsWidgetProvider extends AppWidgetProvider {
	
	public static String response;

	public void onUpdate(Context context, AppWidgetManager appWidgetManager, int[] appWidgetIds)
	{
		final int ids = appWidgetIds.length;
		
		for (int i=0; i<ids; i++)
		{
			int appWidgetId = appWidgetIds[i];
			
			//Intent getHeadlines = new Intent(context, GetHeadlines.class);
			Intent getService = new Intent(context, DataRetrievalService.class);
			
			RemoteViews views = new RemoteViews(context.getPackageName(), R.layout.widget_layout);
			//views.setOnClickPendingIntent(R.id.widget, pi);
			
			Handler retrievalHandler = new Handler()
			{
				@Override
				public void handleMessage(Message msg) 
				{
					if (msg.arg1 == Activity.RESULT_OK)
					{
						try {
							response = (String) msg.obj;
						} catch (Exception e) {
							Log.e("Error","There was a problem retrieving the json Response.");
						}
						String nullResponse = "{\"results\":[],\"count\":0}";
						if (response.equals(nullResponse))
						{
							Log.i("Info","We got back a null response. Uh oh!");
						} else
						{
							//When we get a response...
							try {
								//Try to parse it into a valid location plus state
								JSONObject result = new JSONObject(response);
								JSONArray resultArray = result.getJSONArray("headlines");
								int numberOfResults = resultArray.length();
								for (int x = 1; x<6; x++)
								{
									JSONObject thisHeadline = resultArray.getJSONObject(1-x);
									String thisHeadlineText = thisHeadline.getString("headline");
								String nearestPlace = thisLocation.getString("toponymName");
								String state = thisLocation.getString("adminCode1");
								location = nearestPlace+", "+state;
								Log.i("Location",location);
							} catch (JSONException e) {
								Log.e("Error","Problem parsing JSON data!");
								e.printStackTrace();
							}*/
						}
					}
				}
			};
			Messenger apiMessenger = new Messenger(retrievalHandler);
			
			getService.putExtra(com.scottcaruso.headlineretrieval.DataRetrievalService.MESSENGER_KEY, apiMessenger);
			PendingIntent ps = PendingIntent.getService(context, 0, getService, 0);
			
			try {
				ps.send();
			} catch (CanceledException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			
			appWidgetManager.updateAppWidget(appWidgetId, views);
		}
		
	}
	
	public void onDeleted(Context context, int[] appWidgetIds)
	{
		//doNothing
	}
	
	public void getHeadlines()
    {
		
    }
}
