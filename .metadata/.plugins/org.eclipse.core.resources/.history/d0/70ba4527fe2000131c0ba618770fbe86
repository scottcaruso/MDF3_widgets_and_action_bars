package com.scottcaruso.news_feed_widget;

import java.util.ArrayList;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.scottcaruso.news_feed_widget.R;

import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.os.Messenger;
import android.annotation.SuppressLint;
import android.app.Activity;
import android.appwidget.AppWidgetManager;
import android.content.Intent;
import android.util.Log;
import android.view.Menu;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Toast;

public class MainActivity extends Activity {
	
	public String response;
	public ArrayList<String> headlines;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_main);
		
		ArrayList<String> myHeadlines = getHeadlnes();
	}

	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
		// Inflate the menu; this adds items to the action bar if it is present.
		getMenuInflater().inflate(R.menu.main, menu);
		return true;
	}
	
    @SuppressLint("HandlerLeak")
	public ArrayList<String> getHeadlnes()
    {
     	Handler retrievalHandler = new Handler()
		{
			@Override
			public void handleMessage(Message msg) 
			{
				if (msg.arg1 == RESULT_OK)
				{
					try {
						response = (String) msg.obj;
					} catch (Exception e) {
						Log.e("Error","There was a problem retrieving the json Response.");
					}
					String nullResponse = "{\"results\":[],\"count\":0}";
					if (response.equals(nullResponse))
					{
						Toast toast = Toast.makeText(MainActivity.this, "There was a problem retrieving Geo data. Please try again later.", Toast.LENGTH_SHORT);
						toast.show();
					} else
					{
						//When we get a response...
						headlines = new ArrayList<String>();
						//When we get a response...
						try {
							//Try to parse it into a valid location plus state
							JSONObject result = new JSONObject(response);
							JSONArray resultArray = result.getJSONArray("headlines");
							for (int x = 0; x<6; x++)
							{
								JSONObject thisHeadline = resultArray.getJSONObject(x);
								String thisHeadlineText = thisHeadline.getString("headline");
								headlines.add(thisHeadlineText);
							}
						} catch (JSONException e) {
							Log.e("Error","Problem parsing JSON data!");
							e.printStackTrace();
						}
					}
				}
			}
		};
		Messenger apiMessenger = new Messenger(retrievalHandler);

		Intent startDataService = new Intent(this, com.scottcaruso.headlineretrieval.DataRetrievalService.class);
		startDataService.putExtra(com.scottcaruso.headlineretrieval.DataRetrievalService.MESSENGER_KEY, apiMessenger);
		this.startService(startDataService);
	return headlines;
    }

}
